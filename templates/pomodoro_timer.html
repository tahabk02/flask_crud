{% extends "base.html" %}

{% block title %}Pomodoro - {{ task.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-info text-white text-center">
                <h4 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Session Pomodoro
                </h4>
            </div>
            <div class="card-body text-center">
                <h5 class="card-title mb-4">{{ task.title }}</h5>
                
                <div class="mb-4">
                    <div class="display-1 text-primary mb-3" id="timer-display">
                        {{ '%02d:%02d'|format(task.pomodoro_duration, 0) }}
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-info" role="progressbar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <p class="text-muted mb-0" id="timer-status">Prêt à commencer</p>
                </div>
                
                <div class="mb-4">
                    <button class="btn btn-success btn-lg me-2" id="start-btn" onclick="startTimer()">
                        <i class="fas fa-play me-2"></i>Démarrer
                    </button>
                    <button class="btn btn-warning btn-lg me-2" id="pause-btn" onclick="pauseTimer()" disabled>
                        <i class="fas fa-pause me-2"></i>Pause
                    </button>
                    <button class="btn btn-secondary btn-lg" id="reset-btn" onclick="resetTimer()">
                        <i class="fas fa-redo me-2"></i>Reset
                    </button>
                </div>
                
                <div class="row text-center">
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Sessions</h6>
                                <span class="badge bg-success fs-6" id="sessions-count">{{ task.pomodoro_sessions }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Travail</h6>
                                <span class="badge bg-primary fs-6">{{ task.pomodoro_duration }}min</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">Pause</h6>
                                <span class="badge bg-warning fs-6">{{ task.break_duration }}min</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audio pour les notifications -->
<audio id="notification-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
</audio>

<script>
let timer;
let timeLeft;
let totalTime;
let isRunning = false;
let isWorkSession = true;
let sessionsCompleted = {{ task.pomodoro_sessions }};

const workDuration = {{ task.pomodoro_duration }} * 60; // en secondes
const breakDuration = {{ task.break_duration }} * 60; // en secondes

const timerDisplay = document.getElementById('timer-display');
const progressBar = document.getElementById('progress-bar');
const timerStatus = document.getElementById('timer-status');
const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const resetBtn = document.getElementById('reset-btn');
const sessionsCount = document.getElementById('sessions-count');
const notificationSound = document.getElementById('notification-sound');

function initTimer() {
    timeLeft = workDuration;
    totalTime = workDuration;
    isWorkSession = true;
    updateDisplay();
    updateStatus();
}

function updateDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = ((totalTime - timeLeft) / totalTime) * 100;
    progressBar.style.width = `${progress}%`;
    
    if (isWorkSession) {
        progressBar.className = 'progress-bar bg-info';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }
}

function updateStatus() {
    if (isRunning) {
        timerStatus.textContent = isWorkSession ? 'Session de travail en cours...' : 'Pause en cours...';
    } else {
        timerStatus.textContent = isWorkSession ? 'Prêt à travailler' : 'Prêt pour la pause';
    }
}

function startTimer() {
    if (!isRunning) {
        isRunning = true;
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        
        timer = setInterval(() => {
            timeLeft--;
            updateDisplay();
            updateStatus();
            
            if (timeLeft <= 0) {
                completeSession();
            }
        }, 1000);
    }
}

function pauseTimer() {
    if (isRunning) {
        isRunning = false;
        clearInterval(timer);
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        timerStatus.textContent = 'En pause';
    }
}

function resetTimer() {
    isRunning = false;
    clearInterval(timer);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    initTimer();
}

function completeSession() {
    isRunning = false;
    clearInterval(timer);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    
    // Jouer le son de notification
    notificationSound.play().catch(e => console.log('Impossible de jouer le son'));
    
    if (isWorkSession) {
        // Session de travail terminée
        sessionsCompleted++;
        sessionsCount.textContent = sessionsCompleted;
        
        // Enregistrer la session complétée
        fetch(`/complete_pomodoro/{{ task.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // Passer à la pause
        isWorkSession = false;
        timeLeft = breakDuration;
        totalTime = breakDuration;
        timerStatus.textContent = 'Session terminée! Temps de pause.';
        
        // Notification du navigateur
        if (Notification.permission === 'granted') {
            new Notification('Pomodoro terminé!', {
                body: 'Temps de faire une pause de {{ task.break_duration }} minutes.',
                icon: '/static/favicon.ico'
            });
        }
    } else {
        // Pause terminée
        isWorkSession = true;
        timeLeft = workDuration;
        totalTime = workDuration;
        timerStatus.textContent = 'Pause terminée! Prêt pour une nouvelle session.';
        
        // Notification du navigateur
        if (Notification.permission === 'granted') {
            new Notification('Pause terminée!', {
                body: 'Temps de reprendre le travail.',
                icon: '/static/favicon.ico'
            });
        }
    }
    
    updateDisplay();
}

// Demander la permission pour les notifications
if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission();
}

// Initialiser le timer
initTimer();

// Empêcher la fermeture accidentelle de la page
window.addEventListener('beforeunload', function(e) {
    if (isRunning) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}